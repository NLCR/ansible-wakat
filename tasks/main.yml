---
- name: Package provision
  package:
    name: git, docker, docker-python
    state: '{{ wa_kat.state | default("present") }}'

- name: 'Clone WA-KAT: {{ wa_kat.release | default("HEAD") }} to {{ wa_kat.path | default ("/opt/git/wa-kat") }}'
  git:
   repo: 'https://github.com/WebarchivCZ/WA-KAT.git'
   accept_hostkey: True
   force: yes
   dest: '{{ wa_kat.path | default("/opt/git/wa-kat") }}'
   version: '{{ wa_kat.release | default("HEAD") }}'

- name: Docker is running even after restart
  service:
    name: docker
    state: started
    enabled: True

- name: 'Building wa-kat: {{ wa_kat.release | default("HEAD") }} from repo'
  docker_image:
    path: '{{ wa_kat.path | default("/opt/git/wa-kat") }}'
    name: wa-kat
    tag: '{{ wa_kat.release | default("latest") }}'

- name: 'wa-kat: {{ wa_kat.release | default("latest") }} image is running'
  docker_container:
    name: 'wa-kat'
    image: 'wa-kat:{{ wa_kat.release | default("latest") }}'
    state: started
    ports: '{{ wa_kat.port | default("8080") }}:8080'

- name: Configuration for NGINX is present
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  with_items:
    - { src: "nginx-wakat.conf.j2", dest: "/etc/nginx/conf.d/wakat.conf" }
  tags: config
  notify:
    - reload nginx
  when: wa_kat.hostname is defined
